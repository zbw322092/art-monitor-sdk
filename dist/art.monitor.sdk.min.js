!function(){"use strict";const e=Math.random().toString(36).substr(2,9)+"_"+Date.now();window.TRACKID=e;const t=XMLHttpRequest.prototype.send,n=[],o=[];let r=!1;const s=(e,t)=>{for(let n=0,o=e.length;n<o;n++)e[n](t)},i=e=>{4===e.readyState&&s(o,e)},a=e=>{o.push(e)},c=()=>{r||(XMLHttpRequest.prototype.send=function(){if(s(n,this),this.addEventListener){const e=this;this.addEventListener("readystatechange",function(){i(e)},!1)}else(e=>{const t=e.onreadystatechange;t&&(e.onreadystatechange=function(){i(e),t()})})(this);t.apply(this,arguments)},r=!0)};class l{constructor(e){this.timestamp=performance.now(),this.trackId=window.TRACKID,this.TrackType=e}}const u=e=>{let t;switch(e.responseType){case"":case"text":t=e.response;break;case"json":t=JSON.stringify(e.response);break;default:t=Object.prototype.toString.call(e.response)}return t};class d extends l{constructor(e,t){super(e),this.responseURL=t.responseURL,this.status=t.status,this.statusText=t.statusText,this.responseType=t.responseType,this.response=u(t),this.readyState=t.readyState,this.timeout=t.timeout}}var h;!function(e){e.EVENT="event",e.KEYBOARDEVENT="keyboardEvent",e.MOUSEEVENT="mouseEvent",e.TOUCHEVENT="touchEvent",e.STATECHANGE="statechange",e.MUTATION="mutation",e.XHRINTERCEPT="XHRIntercept",e.ERROR="error"}(h||(h={}));const p=e=>new Promise((t,n)=>{e.onsuccess=(()=>{t(e.result)}),e.onerror=(()=>{n(e.error)})}),g=(e,t,n)=>{let o;const r=new Promise((r,s)=>{(o=e[t].apply(e,n))&&p(o).then(r,s)});return r.request=o,r},f=(e,t,n)=>{n.forEach(n=>{Object.defineProperty(e.prototype,n,{get(){return this[t][n]},set(e){return this[t][n]=e}})})},y=(e,t,n,o)=>{o.forEach(o=>{o in n.prototype&&(e.prototype[o]=function(){return g(this[t],o,arguments)})})};function m(e,t,n,o){o.forEach(o=>{o in n.prototype&&(e.prototype[o]=function(){return this[t][o].apply(this[t],arguments)})})}const E=(e,t,n,o,r)=>{o.forEach(o=>{o in n.prototype&&(e.prototype[o]=function(){return((e,t,n,o)=>{const r=g(e,t,n);return r.then(e=>{if(e)return new o(e,r.request)})})(this[t],o,arguments,r)})})};function b(e,t){this._cursor=e,this._request=t}function w(e){this._index=e}function T(e){this._store=e}function v(e){this._tx=e,this.complete=new Promise((t,n)=>{e.oncomplete=(()=>{t()}),e.onerror=(()=>{n(e.error)}),e.onabort=(()=>{n(e.error)})})}function S(e,t,n){this._db=e,this.oldVersion=t,this.transaction=n?new v(n):null}function N(e){this._db=e}f(b,"_cursor",["direction","key","primaryKey","value"]),y(b,"_cursor",IDBCursor,["update","delete"]),f(w,"_index",["name","keyPath","multiEntry","unique"]),y(w,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),E(w,"_index",IDBIndex,["openCursor","openKeyCursor"],b),T.prototype.createIndex=function(){return new w(this._store.createIndex.apply(this._store,arguments))},T.prototype.index=function(){return new w(this._store.index.apply(this._store,arguments))},f(T,"_store",["name","keyPath","indexNames","autoIncrement"]),y(T,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),E(T,"_store",IDBObjectStore,["openCursor","openKeyCursor"],b),y(T,"_store",IDBObjectStore,["deleteIndex"]),v.prototype.objectStore=function(){return new T(this._tx.objectStore.apply(this._tx,arguments))},f(v,"_tx",["objectStoreNames","mode"]),m(v,"_tx",IDBTransaction,["abort"]),S.prototype.createObjectStore=function(){return new T(this._db.createObjectStore.apply(this._db,arguments))},f(S,"_db",["name","version","objectStoreNames"]),m(S,"_db",IDBDatabase,["deleteObjectStore","close"]),f(N,"_db",["name","version","objectStoreNames"]),m(N,"_db",IDBDatabase,["close"]),N.prototype.transaction=function(){return new v(this._db.transaction.apply(this._db,arguments))},["advance","continue","continuePrimaryKey"].forEach(e=>{e in IDBCursor.prototype&&(b.prototype[e]=function(){const t=this,n=arguments;return Promise.resolve().then(()=>(t._cursor[e].apply(t._cursor,n),p(t._request).then(e=>{if(e)return new b(e,t._request)})))})}),["openCursor","openKeyCursor"].forEach(e=>{[T,w].forEach(t=>{e in t.prototype&&(t.prototype[e.replace("open","iterate")]=function(){const t=(n=arguments,Array.prototype.slice.call(n));var n;const o=t[t.length-1],r=this._store||this._index,s=r[e].apply(r,t.slice(0,-1));s.onsuccess=(()=>{o(s.result)})})})}),[w,T].forEach(e=>{e.prototype.getAll||(e.prototype.getAll=function(e,t){const n=this,o=[];return new Promise(r=>{n.iterateCursor(e,e=>{e?(o.push(e.value),void 0===t||o.length!==t?e.continue():r(o)):r(o)})})})});const O={open:(e,t,n)=>{const o=g(indexedDB,"open",[e,t]),r=o.request;return r&&(r.onupgradeneeded=(e=>{n&&n(new S(r.result,e.oldVersion,r.transaction))})),o.then(e=>new N(e))},delete:e=>g(indexedDB,"deleteDatabase",[e])},D=1,I="ERROR-REPORTING";const R=new class{constructor(e,t){this.get=((e,t)=>this.dbPromise.then(n=>n.transaction(e).objectStore(e).get(t))),this.set=((e,t)=>this.dbPromise.then(n=>{const o=n.transaction(e,"readwrite");return o.objectStore(e).put(t),o.complete})),this.delete=((e,t)=>this.dbPromise.then(n=>{const o=n.transaction(e,"readwrite");return o.objectStore(e).delete(t),o.complete})),this.clear=(e=>this.dbPromise.then(t=>{const n=t.transaction(e,"readwrite");return n.objectStore(e).clear(),n.complete})),this.getDBPromise=(()=>this.dbPromise),this.keys=(e=>this.dbPromise.then(t=>{const n=t.transaction(e),o=[],r=n.objectStore(e);return(r.iterateKeyCursor||r.iterateCursor).call(r,e=>{e&&(o.push(e.key),e.continue())}),n.complete.then(()=>o)})),this.dbPromise=O.open(e,D,t)}deleteDataBase(e){return O.delete(e).then(()=>{console.log(`delete ${e} database successfully`)}).catch(t=>{console.log(`delete ${e} database err: `,t)})}}("QNN-MKT",e=>{if(!e.objectStoreNames.contains(I)){e.createObjectStore(I,{keyPath:"id",autoIncrement:!0}).createIndex("timestamp","timestamp")}});a(e=>{const t=new d(h.XHRINTERCEPT,e);console.log("xhr log: ",t),R.set(I,t).then(()=>{console.log("xhr log added")}).catch(e=>{console.log("xhr log err: ",e)})}),c();const C=e=>{let t;return t="function"==typeof Element?e instanceof Element:!!e&&"object"==typeof e&&1===e.nodeType&&"string"==typeof e.nodeName},x=e=>e.tagName.toLowerCase().replace(/:/g,"\\:"),A=(e,t)=>{if(!t)return!1;const n=e.ownerDocument;if(null===n)return!1;const o=n.querySelectorAll(t);return 1===o.length&&o[0]===e},K=(e,t)=>{const n=(e=>{const t=e.getAttribute("id");return null!==t&&""!==t?t.match(/^\d/)?`[id="${t}"]`:"#"+t:null})(e);if(n)return n;const o=(e=>{if(!e.hasAttribute("class"))return null;try{return Array.prototype.slice.call(e.classList).filter(e=>/^[a-z_-][a-z\d_-]*$/i.test(e)).map(e=>`.${e}`).join("")}catch(t){let n=e.getAttribute("class");return(n=n.trim().replace(/\s+/g," ")).split(" ").map(e=>`.${e}`).join("")}})(e);if(o&&A(e,o))return o;const r=((e,t=["id","class","length"])=>{const{attributes:n}=e;if(null===n)return null;const o=[];return Array.prototype.forEach.call(n,e=>{t.indexOf(e.nodeName)>-1||o.push(`[${e.nodeName}="${e.nodeValue}"]`)}),o.join("")})(e,t);if(r&&A(e,r))return r;if(o&&r&&A(e,o+r))return o+r;const s=x(e);return A(e,s)?s:o&&r&&A(e,o+r+" "+s)?o+r+" "+s:null},_=(e,t={})=>{const{attributesToIgnore:n=["id","class","length"]}=t,o=(e=>{const t=[];let n=e;for(;C(n);)t.push(n),n=n.parentElement;return t})(e);let r,s="",i=-1;for(const e of o){const t=K(e,n);if(i++,t){r=e,s=t;break}}if(r===e)return s;return o.slice(0,i).forEach(e=>{s=s+" "+x(e)+(e=>{let t=0;const{parentElement:n}=e;if(n){const{children:o}=n,r=o.length;for(let n=0;n<r;n++)if(t++,o[n]===e)return`:nth-child(${t})`}return null})(e)}),s},L=e=>(e=>e instanceof Node&&!(e instanceof Element))(e)?e.parentElement?_(e.parentElement)+", nodeValue: "+e.nodeValue:"":_(e),P=e=>e instanceof Node?L(e):JSON.stringify(Array.prototype.map.call(e,e=>L(e)));class j extends l{constructor(e,t){super(e),this.type=t.type,this.target=P(t.target),this.addedNode=P(t.addedNodes),this.removedNodes=P(t.removedNodes),this.attributeName=t.attributeName,this.attributeNamespace=t.attributeNamespace,this.previousSibling=t.previousSibling?P(t.previousSibling):null,this.nextSibling=t.nextSibling?P(t.nextSibling):null,this.oldValue=t.oldValue}}const k=document.querySelector("body");let X;const H={attributes:!0,attributeOldValue:!0,childList:!0,characterData:!0,characterDataOldValue:!0,subtree:!0},V=new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"style"===e.attributeName&&X||(e=>{const t=new j(h.MUTATION,e);console.log("mutaion log",t),R.set(I,t).then(()=>{console.log("mutaion log added")}).catch(e=>{console.log("mutaion log err: ",e)}),"attributes"===e.type&&"style"===e.attributeName&&(X=window.setTimeout(()=>{window.clearTimeout(X),X=null},1e3))})(e)})});k&&V.observe(k,H);const B=e=>null===e?null:e instanceof Element?_(e):Object.prototype.toString.call(e);class M extends l{constructor(e,t){super(e),this.type=t.type,this.eventPhase=t.eventPhase,this.currentTarget=B(t.currentTarget),this.target=B(t.target)}}class q extends M{constructor(e,t){super(e,t);const{detail:n}=t;this.detail=n}}class U extends q{constructor(e,t){super(e,t),this.altKey=t.altKey,this.button=t.button,this.buttons=t.buttons,this.clientX=t.clientX,this.clientY=t.clientY,this.ctrlKey=t.ctrlKey,this.metaKey=t.metaKey,this.movementX=t.movementX,this.movementY=t.movementY,this.offsetX=t.offsetX,this.offsetY=t.offsetY,this.pageX=t.pageX,this.pageY=t.pageY,this.relatedTarget=B(t.relatedTarget),this.screenX=t.screenX,this.screenY=t.screenY,this.shiftKey=t.shiftKey}}let Y,z;["click","dblclick"].forEach(e=>{window.addEventListener(e,e=>{const t=new U(h.MOUSEEVENT,e);console.log("click log: ",t),R.set(I,t).then(()=>{console.log("click log added")}).catch(e=>{console.log("click log err: ",e)})})}),window.addEventListener("scroll",e=>{if(Y)return;const t=new M(h.EVENT,e);console.log("scroll log: ",t),R.set(I,t).then(()=>{console.log("scroll log added")}).catch(e=>{console.log("scroll log err: ",e)}),Y=window.setTimeout(()=>{Y=null},1e3)}),window.addEventListener("resize",e=>{if(z)return;const t=new M(h.EVENT,e);console.log("resize log: ",t),R.set(I,t).then(()=>{console.log("resize log added")}).catch(e=>{console.log("resize log err: ",e)}),z=window.setTimeout(()=>{z=null},1e3)});class $ extends q{constructor(e,t){super(e,t),this.altKey=t.altKey,this.code=t.code,this.ctrlKey=t.ctrlKey,this.key=t.key,this.location=t.location,this.metaKey=t.metaKey,this.repeat=t.repeat,this.shiftKey=t.shiftKey}}["keydown"].forEach(e=>{window.addEventListener(e,e=>{const t=new $(h.KEYBOARDEVENT,e);console.log("keyboard log: ",t),R.set(I,t).then(()=>{console.log("keyboard log added")}).catch(e=>{console.log("keyboard log err: ",e)})})});class J extends q{constructor(e,t){super(e,t),this.altKey=t.altKey,this.changedTouches=JSON.stringify(G(t.changedTouches)),this.ctrlKey=t.ctrlKey,this.metaKey=t.metaKey,this.shiftKey=t.shiftKey,this.targetTouches=JSON.stringify(G(t.targetTouches)),this.touches=JSON.stringify(G(t.touches))}}function G(e){const t=["altitudeAngle","azimuthAngle","clientX","clientY","force","identifier","pageX","pageY","radiusX","radiusY","rotationAngle","screenX","screenY","target"];return Array.prototype.map.call(e,e=>{const n={};return t.forEach(t=>{n[t]="target"===t?B(e[t]):e[t]}),n})}let F,Q;["touchstart","touchend"].forEach(e=>{window.addEventListener(e,e=>{const t=new J(h.TOUCHEVENT,e);console.log("touchLog: ",t),R.set(I,t).then(()=>{console.log("touch log added")}).catch(e=>{console.log("touch log err: ",e)})})}),window.addEventListener("touchmove",e=>{if(F)return;const t=new J(h.TOUCHEVENT,e);console.log("touchmoveLog: ",t),R.set(I,t).then(()=>{console.log("touch log added")}).catch(e=>{console.log("touch log err: ",e)}),F=window.setTimeout(()=>{F=null},1e3)});try{new EventTarget,Q=!0}catch(e){Q=!1}var Z=Q?EventTarget:class{constructor(){this.registry={}}addEventListener(e,t){this.getRegistry(e).push(t)}removeEventListener(e,t){const n=this.getRegistry(e),o=n.indexOf(t);o>-1&&n.splice(o,1)}dispatchEvent(e){return e.target=this,Object.freeze(e),this.getRegistry(e.type).forEach(t=>t(e)),!0}getRegistry(e){return this.registry[e]||[]}};var W,ee,te=Q?Event:class{constructor(e){this.type=e}};class ne extends te{constructor(e,t){super(e),this.newState=t.newState,this.prevState=t.prevState,this.originalEvent=t.originalEvent}}!function(e){e.ACTIVE="active",e.PASSIVE="passive",e.HIDDEN="hidden",e.FROZEN="frozen",e.TERMINATED="terminated"}(W||(W={})),function(e){e.focus="focus",e.blur="blur",e.visibilitychange="visibilitychange",e.freeze="freeze",e.resume="resume",e.pageshow="pageshow",e.pagehide="pagehide",e.unload="unload"}(ee||(ee={}));const oe=W.ACTIVE,re=W.PASSIVE,se=W.HIDDEN,ie=W.FROZEN,ae=W.TERMINATED,ce=window.safari,le="object"==typeof ce&&ce.pushNotification,ue="onpageshow"in self,de=[ee.focus,ee.blur,ee.visibilitychange,ee.freeze,ee.resume,ee.pageshow,ue?ee.pagehide:ee.unload],he=e=>(e.preventDefault(),e.returnValue=!0),pe=[[oe,re,se,ae],[oe,re,se,ie],[se,re,oe],[ie,se],[ie,oe],[ie,re]].map(e=>e.reduce((e,t,n)=>(e[t]=n,e),{})),ge=(e,t)=>{for(let n=0,o=pe.length;n<o;++n){const o=pe[n],r=o[e],s=o[t];if(r>=0&&s>=0&&s>r)return Object.keys(o).slice(r,s+1)}return[]},fe=()=>document.visibilityState===se?se:document.hasFocus()?oe:re;class ye extends M{constructor(e,t){super(e,t),this.newState=t.newState,this.prevState=t.prevState}}(new class extends Z{constructor(){super(),this.safariBeforeUnloadTimeout=void 0,this.handleEvents=(e=>{switch(le&&window.clearTimeout(this.safariBeforeUnloadTimeout),e.type){case"pageshow":case"resume":this.dispatchChangesIfNeeded(e,fe());break;case"focus":this.dispatchChangesIfNeeded(e,oe);break;case"blur":this.currState===oe&&this.dispatchChangesIfNeeded(e,fe());break;case"pagehide":case"unload":this.dispatchChangesIfNeeded(e,e.persisted?ie:ae);break;case"visibilitychange":this.currState!==ie&&this.currState!==ae&&this.dispatchChangesIfNeeded(e,fe());break;case"freeze":this.dispatchChangesIfNeeded(e,ie)}});const e=fe();this.currState=e,this.unsavedChanges=[],de.forEach(e=>window.addEventListener(e,this.handleEvents,!0)),le&&window.addEventListener("beforeunload",e=>{this.safariBeforeUnloadTimeout=window.setTimeout(()=>{e.defaultPrevented||e.returnValue||this.dispatchChangesIfNeeded(e,se)},0)})}get State(){return this.currState}get pageWasDiscarded(){return document.wasDiscarded||!1}addUnsavedChanges(e){this.unsavedChanges.indexOf(e)>-1||(0===this.unsavedChanges.length&&window.addEventListener("beforeunload",he),this.unsavedChanges.push(e))}removeUnsavedChanges(e){const t=this.unsavedChanges.indexOf(e);t>-1&&(this.unsavedChanges.splice(t,1),0===this.unsavedChanges.length&&window.removeEventListener("beforeunload",he))}dispatchChangesIfNeeded(e,t){if(t!==this.currState){const n=this.currState,o=ge(n,t);for(let t=0,n=o.length;t<n-1;++t){const n=o[t],r=o[t+1];this.currState=r,this.dispatchEvent(new ne("statechange",{prevState:n,newState:r,originalEvent:e}))}}}}).addEventListener("statechange",e=>{const t=new ye(h.STATECHANGE,e);console.log("statechange log: ",t),R.set(I,t).then(()=>{console.log("statechange log added")}).catch(e=>{console.log("statechange log err: ",e)}),t.newState===W.TERMINATED&&R.deleteDataBase("QNN-MKT")});performance.getEntries();window.setInterval(()=>{const e=performance.now(),t=IDBKeyRange.bound(e-2e4-20,e-1e4+20);let n,o,r=0;R.getDBPromise().then(e=>{return e.transaction(I).objectStore(I).index("timestamp").openCursor(t)}).then(function e(t){if(!t)return;const s=t.primaryKey;return void 0===n&&(n=s),void 0===o&&(o=s),n=s<n?s:n,o=s>o?s:o,r++,t.continue().then(e)}).then(function(){n!==o?R.delete(I,IDBKeyRange.bound(n,o)).then(()=>{console.log(`${r} records deleted`)}).catch(e=>{console.log("delete record has err: ",e)}):console.log("no new records")})},1e4);class me extends M{constructor(e,t){super(e,t),this.message=t.message,this.filename=t.filename,this.lineno=t.lineno,this.colno=t.colno,this.error=JSON.stringify(t.error)}}var Ee,be;function we(e,t,n){let o=t.xhr||null;const r=XMLHttpRequest||Te,s="withCredentials"in new r?XMLHttpRequest:window.XDomainRequest,{headers:i={},method:a=Ee.GET,username:c,password:l,withCredentials:u,timeout:d,responseType:h,beforeSend:p,useXDR:g,json:f}=t;let y=t.body;const m=!!t.sync;let E,b=!1;const w={body:{},headers:{},statusCode:0,method:a,url:e,rawRequest:o};null===o&&(o=g?new s:new r),!0===f&&((i.accept||i.Accept)&&(i.Accept="application/json"),a!==Ee.GET&&a!==Ee.HEAD&&((i["content-type"]||i["Content-Type"])&&(i["Content-Type"]="application/json"),y=JSON.stringify(y)));let T=!1;const v=function(e,t,o){T||(T=!0,n(e,t,o))};function S(){let e;if(e=o.response?o.response:o.responseText||function(e){try{if("document"===e.responseType)return e.responseXML;const t=e.responseXML&&"parsererror"===e.responseXML.documentElement.nodeName;if(""===e.responseType&&!t)return e.responseXML}catch(e){console.log("getXml: ",e)}return null}(o),f)try{e=JSON.parse(e)}catch(e){console.log("JSON parse error: ",e)}return e}function N(){if(b)return;let t,n,r=w;return clearTimeout(E),0!==(t=g&&void 0===o.status?200:1223===o.status?204:o.status)?(r={body:S(),statusCode:t,method:a,headers:{},url:e,rawRequest:o},o.getAllResponseHeaders&&(r.headers=function(e){if(!e)return{};const t={};return e.trim().split("\n").forEach(e=>{const n=e.indexOf(":"),o=e.slice(0,n).trim().toLowerCase(),r=e.slice(n+1).trim();void 0===t[o]?t[o]=r:function(e){return"[object Array]"===Object.prototype.toString.call(e)}(t[o])?t[o].push(r):t[o]=[t[o],r]}),t}(o.getAllResponseHeaders()))):n=new Error("Internal XMLHttpRequest Error"),v(n,r,r.body)}function O(e){return clearTimeout(E),e instanceof Error||(e=new Error(""+(e||"Unknown XMLHttpRequest Error"))),e.statusCode=0,v(e,w,w.body)}if(o.onreadystatechange=(()=>{o.readyState===be.DONE&&setTimeout(N,0)}),o.onload=N,o.onerror=O,o.onprogress=(()=>{}),o.onabort=(()=>{b=!0}),o.ontimeout=O,o.open(a,e,!m,c,l),m||(o.withCredentials=!!u),!m&&d&&d>0&&(E=setTimeout(()=>{if(b)return;b=!0,o.abort();const e=new Error("XMLHttpRequest timeout");e.code="ETIMEDOUT",O(e)},d)),o.setRequestHeader)for(const e in i)i.hasOwnProperty(e)&&o.setRequestHeader(e,i[e]);else if(i&&function(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0}(i))throw new Error("Headers cannot be set on an XDomainRequest object");return h&&(o.responseType=h),p&&"function"==typeof t.beforeSend&&p(o),o.send(y||null),o}function Te(){}!function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e.HEAD="HEAD",e.OPTIONS="OPTIONS"}(Ee||(Ee={})),function(e){e[e.UNSENT=0]="UNSENT",e[e.OPENED=1]="OPENED",e[e.HEADERS_RECEIVED=2]="HEADERS_RECEIVED",e[e.LOADING=3]="LOADING",e[e.DONE=4]="DONE"}(be||(be={}));window.addEventListener("error",e=>{(()=>{const e=performance.now(),t=IDBKeyRange.bound(e-1e4,e);let n,o,r,s=0;return R.getDBPromise().then(e=>{const n=e.transaction(I);return(r=n.objectStore(I)).index("timestamp").openCursor(t)}).then(function e(t){if(!t)return;const r=t.primaryKey;return void 0===n&&(n=r),void 0===o&&(o=r),n=r<n?r:n,o=r>o?r:o,s++,t.continue().then(e)}).then(function(){if(n!==o)return r.getAll(IDBKeyRange.bound(n,o)).then(e=>(console.log(`got ${s} records`),e)).catch(e=>e);console.log("no new records")})})().then(t=>{console.log("records within error happened 10s: ",t);const n={info:{},track:{error:new me(h.ERROR,e),behaviors:t}};we("http://me.dev.com:3002/mock_api/error-report",{method:Ee.POST,body:JSON.stringify(n)},(e,t)=>{e?console.log("error report error: ",e):console.log("error report response: ",t)})}).catch(e=>{console.log("get record has err: ",e)})})}();
